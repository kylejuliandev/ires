@page "/people/add"
@rendermode InteractiveServer
@using Ires.Frontend.Components.Pages.People.Models
@using System.Linq.Expressions
@inject IresDbContext DbContext
@inject NavigationManager NavManager

<PageTitle>Create Person</PageTitle>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-6">
            <EditForm class="g-3" EditContext="editContext" OnValidSubmit="@HandleValidSubmit" FormName="person_entry_form">
                <DataAnnotationsValidator />

                <div class="row mb-3">
                    <div class="col">
                        <label for="givenname" class="form-label">First name</label>
                        <div class="input-group has-validation">
                            <InputText id="givenname" class="form-control" @bind-Value="model!.GivenName" />
                            <ValidationMessage For="() => model!.GivenName" class="invalid-feedback" />
                        </div>
                    </div>

                    <div class="col">
                        <label for="lastname" class="form-label">Last name</label>
                        <div class="input-group has-validation">
                            <InputText id="lastname" class="form-control" @bind-Value="model!.FamilyName" />
                            <ValidationMessage For="() => model!.FamilyName" class="invalid-feedback" />
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label for="nickname" class="form-label">Nickname</label>
                        <div class="input-group has-validation">
                            <InputText id="nickname" class="form-control" @bind-Value="model!.Nickname" />
                            <ValidationMessage For="() => model!.Nickname" class="invalid-feedback" />
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label for="gender" class="form-label">Gender</label>
                        <div class="input-group has-validation">
                            <InputSelect id="gender" class="form-control" @bind-Value="model!.Gender">
                                <option value=""></option>
                                <option value="@CreatePersonModelGender.Male">Male</option>
                                <option value="@CreatePersonModelGender.Female">Female</option>
                                <option value="@CreatePersonModelGender.NonBinary">NonBinary</option>
                                <option value="@CreatePersonModelGender.Other">Other</option>
                            </InputSelect>
                            <ValidationMessage For="() => model!.Gender" class="invalid-feedback" />
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="dateofbirth" class="form-label">Date of Birth</label>
                        <div class="input-group has-validation">
                            <InputDate id="dateofbirth" class="form-control" @bind-Value="@model.DateOfBirth" />
                            <ValidationMessage For="@(() => model.DateOfBirth)" class="invalid-feedback" />
                        </div>
                    </div>
                </div>

                <div class="row justify-content-end my-3">
                    <div class="col-auto">
                        <button class="btn btn-primary px-5" type="submit">Submit</button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private EditContext? editContext;

    [SupplyParameterFromForm(FormName = "person_entry_form")]
    private CreatePersonModel? model { get; set; }

    protected override void OnInitialized()
    {
        var faker = new Bogus.Faker<CreatePersonModel>()
            .RuleFor(f => f.GivenName, f => f.Name.FirstName())
            .RuleFor(f => f.FamilyName, f => f.Name.LastName())
            .RuleFor(f => f.DateOfBirth, f => DateOnly.FromDateTime(f.Person.DateOfBirth))
            .RuleFor(f => f.Gender, f => f.PickRandom<CreatePersonModelGender>())
            .Generate(1);

        model ??= faker[0];
        editContext = new EditContext(model);
        editContext.SetFieldCssClassProvider(new CustomFieldClassProvider());
    }

    private async Task HandleValidSubmit()
    {
        var person = new Person()
        {
            GivenName = model.GivenName,
            FamilyName = model.FamilyName,
            Nickname = model.Nickname,
            DateOfBirth = model.DateOfBirth is null ? DateOnly.MinValue : model.DateOfBirth.Value,
            BirthdayDayOfYear = model.DateOfBirth is null ? -1 : model.DateOfBirth.Value.DayOfYear,
            Gender = GetGender(model.Gender),
        };

        DbContext.People.Add(person);
        await DbContext.SaveChangesAsync();

        NavManager.NavigateTo("/people", replace: true);
    }

    private Gender GetGender(CreatePersonModelGender? gender) => gender switch
    {
        CreatePersonModelGender.Male => Gender.Male,
        CreatePersonModelGender.Female => Gender.Female,
        CreatePersonModelGender.NonBinary => Gender.NonBinary,
        CreatePersonModelGender.Other => Gender.NotSpecified,
        _ => Gender.NotSpecified
    };
}
