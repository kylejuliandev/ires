@page "/people/add"
@rendermode InteractiveServer
@using Ires.Frontend.Components.Pages.People.Models
@using System.Linq.Expressions
@inject IresDbContext DbContext
@inject NavigationManager NavManager

<PageTitle>Create Person</PageTitle>

<div class="row justify-content-center">
    <div class="col-8">
        <EditForm class="g-3" EditContext="editContext" OnValidSubmit="@HandleValidSubmit" FormName="person_entry_form">
            <DataAnnotationsValidator />

            <EditPersonForm Model="@model" />

            <div class="container">
                <div class="row justify-content-end my-5">
                    <div class="col-auto">
                        <a class="btn btn-primary px-5" href="people">Back</a>
                        <button class="btn btn-primary px-5" type="submit">Submit</button>
                    </div>
                </div>
            </div>

        </EditForm>
    </div>
</div>

@code {
    private EditContext? editContext;

    [SupplyParameterFromForm(FormName = "person_entry_form")]
    private CreatePersonModel? model { get; set; }

    protected override void OnInitialized()
    {
        var faker = new Bogus.Faker<CreatePersonModel>()
            .RuleFor(f => f.GivenName, f => f.Name.FirstName())
            .RuleFor(f => f.FamilyName, f => f.Name.LastName())
            .RuleFor(f => f.DateOfBirth, f => DateOnly.FromDateTime(f.Person.DateOfBirth))
            .RuleFor(f => f.Gender, f => f.PickRandom<CreatePersonModelGender>())
            .Generate(1);

        model ??= faker[0];
        editContext = new EditContext(model);
        editContext.SetFieldCssClassProvider(new CustomFieldClassProvider());
    }

    private async Task HandleValidSubmit()
    {
        var person = new Person()
        {
            GivenName = model.GivenName,
            FamilyName = model.FamilyName,
            Nickname = model.Nickname,
            DateOfBirth = model.DateOfBirth is null ? DateOnly.MinValue : model.DateOfBirth.Value,
            Gender = model.Gender.GetGender()
        };

        DbContext.People.Add(person);
        await DbContext.SaveChangesAsync();

        NavManager.NavigateTo("/people", replace: true);
    }
}
