@page "/people/{id:guid}/edit"
@using Ires.Frontend.Components.Pages.People.Models
@rendermode InteractiveServer
@inject IresDbContext DbContext

<PageTitle>Edit Person</PageTitle>

<div class="row justify-content-center">
    <div class="col-8">
        <EditForm class="g-3" EditContext="editContext" OnValidSubmit="@HandleValidSubmit" FormName="person_entry_form">
            <DataAnnotationsValidator />
            
            <EditPersonForm Model="@model" />

            <br />

            <EditAddressForm PersonId="@Id" Model="@model" />

            @if (!string.IsNullOrWhiteSpace(savedMessage))
            {
                <p class="text-success my-2">@savedMessage</p>
            }

            <div class="row justify-content-end mt-5">
                <div class="col-auto">
                    <a class="btn btn-primary px-5" href="people">Back</a>
                    <button class="btn btn-primary px-5" type="submit">Submit</button>
                </div>
            </div>

        </EditForm>        
    </div>
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private EditContext? editContext;

    private string? savedMessage;

    [SupplyParameterFromForm(FormName = "person_entry_form")]
    private CreatePersonModel? model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var person = await DbContext.People.FindAsync(Id);
        model = new CreatePersonModel
        {
            GivenName = person!.GivenName,
            FamilyName = person.FamilyName,
            Nickname = person.Nickname ?? string.Empty,
            DateOfBirth = person.DateOfBirth
        };
        editContext = new EditContext(model);
        editContext.SetFieldCssClassProvider(new CustomFieldClassProvider());
    }

    private async Task HandleValidSubmit()
    {
        var person = await DbContext.People.FindAsync(Id);
        person!.GivenName = model.GivenName;
        person.FamilyName = model.FamilyName;
        person.Nickname = model.Nickname;
        person.DateOfBirth = model.DateOfBirth is null ? DateOnly.MinValue : model.DateOfBirth.Value;

        await DbContext.SaveChangesAsync();

        savedMessage = "Successfully saved...";
    }
}
